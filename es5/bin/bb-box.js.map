{"version":3,"sources":["../../src/bin/bb-box.js"],"names":["program","dic","factoryListener","ins","def","setLogger","createLogger","name","instance","box","get","plugin","getAsync","registerPlugin","onCli","console","log","e","warn","message","createBox","op","services","cmd","params","skipDependencies","Error","error","shutdown","runBoxOp","_","require","serviceName","logger","entry","msg","createCommand","command","option","process","on","exit","version","action","partial","service","shell","help","parse","argv"],"mappings":"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","file":"bb-box.js","sourcesContent":["const _ = require('lodash');\n\nconst {dic} = require('./dic');\n\nfunction createLogger(serviceName) {\n  const logger = {\n    log: (entry) => {\n      console.log('[' + serviceName + '] ' + entry.msg);\n    }\n  };\n\n  return logger;\n}\n\nasync function createBox(program) {\n  dic.factoryListener = function(ins, def) {\n    //console.log(def); //XXX\n    if (ins.setLogger) {\n      ins.setLogger(createLogger(def.name));\n    }\n    return ins;\n  };\n\n  dic.instance('bbBoxOpts', {});\n\n  const box = dic.get('bbBox');\n\n  //TODO\n  try {\n    const plugin = await dic.getAsync('dockerComposePlugin');\n    box.registerPlugin(plugin);\n    plugin.onCli(program);\n    console.log('DockerComposePlugin: enabled'); //XXX\n  } catch(e) {\n    console.warn('DockerComposePlugin: disabled - ' + e.message); //XXX\n  }\n\n  try {\n    const plugin = await dic.getAsync('reverseProxyPlugin');\n    box.registerPlugin(plugin);\n    plugin.onCli(program);\n    console.log('ReverseProxyPlugin: enabled'); //XXX\n  } catch(e) {\n    console.warn('ReverseProxyPlugin: disabled - ' + e.message); //XXX\n  }\n    \n  try {\n    const plugin = await dic.getAsync('hostsPlugin');\n    box.registerPlugin(plugin);\n    plugin.onCli(program);\n    console.log('HostsPlugin: enabled'); //XXX\n  } catch(e) {\n    console.warn('HostsPlugin: disabled - ' + e.message); //XXX\n  }\n\n  try {\n    const plugin = await dic.getAsync('sshPlugin');\n    box.registerPlugin(plugin);\n    plugin.onCli(program);\n    console.log('SshPlugin: enabled'); //XXX\n  } catch(e) {\n    console.warn('SshPlugin: disabled - ' + e.message); //XXX\n  }\n\n  // try {\n  //   box.registerPlugin(new GitPlugin());\n  //   console.log('GitPlugin: enabled'); //XXX\n  // } catch(e) {\n  //   console.error('GitPlugin: disabled - no git installed'); //XXX\n  // }\n\n  return box;\n}\n\nfunction createCommand(program, cmd) {\n  return program.command(cmd)\n    .option('--skip-dependencies', 'Skip the operation on the service dependencies')\n}\n\nasync function runBoxOp(box, op, services, cmd) {\n  const params = {\n    services,\n  };\n\n  if (cmd.skipDependencies) {\n    params.skipDependencies = true;\n  }\n\n  if (!box[op]) {\n    throw new Error(`No ${op} implemented on BbBox`);\n  }\n\n  try {\n    await box[op](params);\n  } catch(e) {\n    console.error(e); //XXX\n  }\n\n  await box.shutdown();\n}\n\n(async () => {\n  const program = require('commander');\n\n  const box = await createBox(program);\n  process.on('SIGINT', async function () {\n    await box.shutdown();\n    process.exit(0);\n  });\n\n  program\n    .version(require('../../package.json').version);\n\n  createCommand(program, 'install [services...]')\n    .action(_.partial(runBoxOp, box, 'install'));\n\n  createCommand(program, 'update [services...]')\n    .action(_.partial(runBoxOp, box, 'update'));\n\n  createCommand(program, 'start [services...]')\n    .action(_.partial(runBoxOp, box, 'start'));\n\n  createCommand(program, 'stop [services...]')\n    .action(_.partial(runBoxOp, box, 'stop'));\n\n  createCommand(program, 'reset [services...]')\n    .action(_.partial(runBoxOp, box, 'reset'));\n\n  createCommand(program, 'status [services...]')\n    .action(_.partial(runBoxOp, box, 'status'));\n\n  createCommand(program, 'shell <service>')\n    .action(async (service, cmd) => {\n      const params = {\n        service,\n      };\n\n      try {\n        await box.shell(params);\n      } catch(e) {\n        console.error(e); //XXX\n      }\n\n      await box.shutdown();\n    });\n\n  program.command('help')\n    .action(function() {\n      program.help();\n    });\n\n  program.parse(process.argv);\n})();\n"]}
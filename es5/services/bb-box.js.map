{"version":3,"sources":["../../src/services/bb-box.js"],"names":["_","require","globby","fs","path","AbstractService","Joi","shell","serviceSchema","object","name","string","options","allowUnknown","BbBox","constructor","bbBoxOpts","runtimeLocal","cwd","optional","default","process","plugins","runtimes","local","setLogger","logger","registerPlugin","plugin","register","push","shutdown","onUnregister","runtimeName","install","params","op","runOp","update","start","stop","reset","status","allow","services","array","skipDependencies","boolean","service","discover","ctx","ran","isEmpty","serviceNames","intersection","keys","map","ser","run","outputInfo","serviceName","runtime","runDependecies","_runDependencies","runPlugins","upperFirst","disableOp","isBoolean","disableOps","get","log","level","msg","getRuntime","state","Error","writeFileSync","dependsOn","dep","peerService","ret","filePath","test","loadServiceFile","discoverServices","defaultsDeep","expose","isInteger","port","host","isArray","exp","isUndefined","parent","env","defaults","globalEnv","exec","findService","console","printServiceInfo","childService","p","dir","dirname","pushd","file","localPath","merge","statePath","popd","basename","paths","sync","absolute","e","pluginServices","hook","isFunction","x","config","silent","fatal","module","exports"],"mappings":"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","file":"bb-box.js","sourcesContent":["const _ = require('lodash');\nconst globby = require('globby');\nconst fs = require('fs');\nconst path = require('path');\nconst {AbstractService, Joi} = require('@kapitchi/bb-service');\nconst shell = require('shelljs');\n\nconst serviceSchema = Joi.object({\n  name: Joi.string()\n}).options({allowUnknown: true});\n\nclass BbBox extends AbstractService {\n  /**\n   *\n   * @param bbBoxOpts\n   */\n  constructor(bbBoxOpts, runtimeLocal) {\n    super(bbBoxOpts, {\n      cwd: Joi.string().optional().default(process.cwd()),\n    });\n\n    this.plugins = [];\n    this.runtimes = {\n      local: runtimeLocal\n    };\n  }\n\n  setLogger(logger) {\n    super.setLogger(logger);\n    this.runtimes.local.setLogger(logger);\n  }\n\n  /**\n   *\n   * @param plugin\n   */\n  registerPlugin(plugin) {\n    plugin.register(this);\n    this.plugins.push(plugin);\n  }\n\n  async shutdown() {\n    for (const plugin of this.plugins) {\n      if (plugin['onUnregister']) {\n        await plugin.onUnregister();\n      }\n    }\n\n    for (const runtimeName in this.runtimes) {\n      if (this.runtimes[runtimeName]['onUnregister']) {\n        await this.runtimes[runtimeName].onUnregister();\n      }\n    }\n  }\n\n  /**\n   *\n   * @param params\n   * @returns {Promise.<void>}\n   */\n  async install(params) {\n    params.op = 'install';\n    return this.runOp(params);\n  }\n\n  /**\n   *\n   * @param params\n   * @returns {Promise.<void>}\n   */\n  async update(params) {\n    params.op = 'update';\n    return this.runOp(params);\n  }\n\n  async start(params) {\n    params.op = 'start';\n    return this.runOp(params);\n  }\n\n  async stop(params) {\n    params.op = 'stop';\n    return this.runOp(params);\n  }\n\n  async reset(params) {\n    params.op = 'reset';\n    return this.runOp(params);\n  }\n\n  async status(params) {\n    params.op = 'status';\n    return this.runOp(params);\n  }\n\n  async runOp(params) {\n    params = this.params(params, {\n      op: Joi.string().allow('install', 'update', 'start', 'stop', 'reset', 'status'),\n      services: Joi.array().optional(),\n      skipDependencies: Joi.boolean().optional().default(false)\n    });\n\n    const service = await this.discover();\n\n    const ctx = {\n      ran: {}\n    };\n\n    let services = [];\n    if (!_.isEmpty(params.services)) {\n      //run on selected dependencies\n      const serviceNames = _.intersection(_.keys(service.services), params.services);\n      services = serviceNames.map(name => {\n        return service.services[name];\n      });\n    }\n    else {\n      //run for current/parent service\n      if (!params.skipDependencies) {\n        const serviceNames = _.keys(service.services);\n        //run on dependencies first\n        services = serviceNames.map(name => {\n          return service.services[name];\n        });\n      }\n      //then parent service\n      services.push(service);\n    }\n\n    for (const ser of services) {\n      await this.run({\n        service: ser,\n        op: params.op,\n        ctx,\n        skipDependencies: params.skipDependencies\n      });\n    }\n\n    if (params.op === 'status') {\n      this.outputInfo(service);\n    }\n  }\n\n  async run(params) {\n    //we want this by reference, this.params clones the params\n    const {service, ctx} = params;\n    params = this.params(params, {\n      service: serviceSchema,\n      op: Joi.string().allow('install', 'update', 'start', 'stop', 'reset', 'status'),\n      ctx: Joi.object(),\n      skipDependencies: Joi.boolean().optional().default(false)\n    });\n\n    //make sure we run a particular operation on a service once only\n    if (ctx.ran[service.name + params.op]) {\n      return;\n    }\n\n    const serviceName = `[${service.name}@${service.runtime}]`;\n\n    let runDependecies = true;\n    if (params.op !== 'stop') {\n      await this._runDependencies(ctx, service, params);\n      runDependecies = false;\n    }\n\n    ctx.ran[service.name + params.op] = true;\n\n    await this.runPlugins(`on${_.upperFirst(params.op)}Before`, {\n      service: params.service,\n    });\n\n    let disableOp = false;\n    if (_.isBoolean(service.disableOps)) {\n      disableOp = service.disableOps;\n    } else {\n      disableOp = _.get(service, `disableOps.${params.op}`, false);\n    }\n\n    if (disableOp) {\n      this.logger.log({\n        level: 'info',\n        msg: `${serviceName} Skipping ${params.op}`\n      });\n\n      if (runDependecies) {\n        await this._runDependencies(ctx, service, params);\n      }\n\n      return;\n    }\n\n    this.logger.log({\n      level: 'info',\n      msg: `${serviceName} ${params.op}...`\n    });\n\n    const runtime = await this.getRuntime(service);\n    await runtime.run({\n      service,\n      op: params.op\n    });\n\n    await this.runPlugins(`on${_.upperFirst(params.op)}After`, {\n      service: params.service,\n    });\n\n    if (service.runtime === 'local' && service.state) {\n      if (!service.cwd) {\n        throw new Error('Service has no \"cwd\" set');\n      }\n      fs.writeFileSync(service.cwd + '/bb-box.state.json', JSON.stringify(service.state, null, 2));\n    }\n\n    this.logger.log({\n      level: 'info',\n      msg: `${serviceName} ... done`\n    });\n\n    if (runDependecies) {\n      await this._runDependencies(ctx, service, params);\n    }\n  }\n\n  async _runDependencies(ctx, service, params) {\n    if (!params.skipDependencies && !_.isEmpty(service.dependsOn)) {\n      for (const dep of service.dependsOn) {\n        const peerService = _.get(service, `parent.services.${dep}`);\n        if (!peerService) {\n          throw new Error(`Unknown peer service ${dep} of ${service.name}`);\n        }\n\n        await this.run({\n          service: peerService,\n          op: params.op,\n          ctx: ctx\n        });\n\n        //start peer services for install/update\n        if (params.op === 'install' || params.op === 'update') {\n          await this.run({\n            service: peerService,\n            op: 'start',\n            ctx: ctx\n          });\n        }\n      }\n    }\n  }\n\n  async discover(cwd) {\n    if (!cwd) {\n      cwd = this.options.cwd;\n    }\n\n    let ret = {\n      name: 'ROOT'\n    };\n\n    const filePath = cwd + '/bb-box.js';\n    if (this.shell.test('-f', filePath)) {\n      ret = this.loadServiceFile(filePath);\n    }\n\n    let services = await this.discoverServices(cwd);\n    ret.services = _.defaultsDeep({}, ret.services, services);\n\n    //normalize service properties and set the parent\n    for (const name in ret.services) {\n      const ser = ret.services[name];\n\n      let expose = ser.expose;\n\n      if (_.isInteger(ser.expose)) {\n        expose = [\n          {port: ser.expose, host: 'localhost'}\n        ];\n      } else if (_.isArray(expose)) {\n        expose = expose.map(exp => {\n          return {\n            host: _.get(exp, 'host', 'localhost'),\n            port: exp.port\n          }\n        });\n      } else if (_.isUndefined(expose)) {\n        this.logger.log({\n          level: 'warn',\n          msg: `Service ${name} does not have any exposed ports`\n        });\n      } else {\n        throw new Error('Unknown expose format: ' + expose);\n      }\n\n      ser.expose = expose;\n\n      ser.parent = ret;\n      ser.env = _.defaults({}, ret.services[name].env, ret.globalEnv);\n      ser.exec = _.defaults({}, ret.services[name].exec, _.get(ret, 'defaults.exec'));\n      _.defaults(ser, {\n        runtime: 'local'\n      });\n    }\n\n    return ret;\n  }\n\n  async findService(serviceName) {\n    const service = await this.discover();\n    if (!service.services || !service.services[serviceName]) {\n      return null;\n    }\n    return service.services[serviceName];\n  }\n\n  outputInfo(service) {\n    console.log('=============='); //XXX\n    console.log('Service status'); //XXX\n    console.log('=============='); //XXX\n    this.printServiceInfo(service);\n  }\n\n  printServiceInfo(service) {\n    console.log(`[${service.name}@${service.runtime}]: ${service.status}`); //XXX\n\n    if (!service.services) {\n      return;\n    }\n\n    for (const childService of Object.values(service.services)) {\n      this.printServiceInfo(childService);\n    }\n  }\n\n  loadServiceFile(p) {\n    const dir = path.dirname(p);\n\n    this.shell.pushd(dir);\n\n    const file = require(p);\n\n    const localPath = dir + '/bb-box.local.js';\n    if (this.shell.test('-f', localPath)) {\n      const local = require(localPath);\n      _.merge(file, local);\n    }\n\n    const statePath = dir + '/bb-box.state.json';\n    if (this.shell.test('-f', statePath)) {\n      file.state = require(statePath);\n    } else {\n      file.state = {};\n    }\n\n    this.shell.popd();\n\n    file.cwd = dir;\n\n    if (!file.name) {\n      file.name = path.basename(dir);\n    }\n\n    _.defaults(file, {\n      //runtime: 'local' // cannot be set here, because docker-compose service runtime won't be set\n    });\n\n    return file;\n  }\n\n  async discoverServices(cwd) {\n    const paths = globby.sync('*/bb-box.js', {\n      cwd: cwd,\n      absolute: true\n    });\n\n    const services = {};\n    for (const p of paths) {\n      try {\n        const file = this.loadServiceFile(p);\n        services[file.name] = file;\n      } catch (e) {\n        this.logger.log({\n          level: 'error',\n          msg: `Service file error. Service disabled. ${p}: ${e}`\n        });\n      }\n    }\n\n    const pluginServices = await this.runPlugins('discoverServices');\n\n    //TODO do some magic to merge/select values from discovered plugin services\n    _.defaultsDeep(services, pluginServices);\n\n    return services;\n  }\n\n  /**\n   * Must return something what can be deepMerged\n   *\n   * @param hook\n   * @param [params]\n   * @returns {Promise.<void>}\n   */\n  async runPlugins(hook, params) {\n    const ret = {};\n\n    for (const plugin of this.plugins) {\n      if (!_.isFunction(plugin[hook])) {\n        continue;\n      }\n\n      const x = await plugin[hook](params);\n      _.defaultsDeep(ret, x);\n    }\n\n    return ret;\n  }\n\n  async getRuntime(service) {\n    const runtimeName = _.get(service, 'runtime', 'local');\n    if (!this.runtimes[runtimeName]) {\n      throw new Error(`No runtime registered ${runtimeName}`);\n    }\n\n    return this.runtimes[runtimeName];\n  }\n\n  get shell() {\n    //https://github.com/shelljs/shelljs#configsilent\n    shell.config.reset();\n    shell.config.silent = true;\n    shell.config.fatal = true;\n    //shell.config.verbose = true;\n    return shell;\n  }\n}\n\nmodule.exports = BbBox;\n"]}
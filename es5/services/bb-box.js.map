{"version":3,"sources":["../../src/services/bb-box.js"],"names":["_","require","globby","fs","path","AbstractService","Joi","shell","iplib","serviceSchema","object","name","string","options","allowUnknown","BbBox","constructor","bbBoxOpts","runtimeLocal","cwd","optional","default","process","plugins","runtimes","local","setLogger","logger","registerPlugin","plugin","register","push","shutdown","onUnregister","runtimeName","install","params","op","runOp","update","start","stop","reset","status","allow","services","array","skipDependencies","boolean","service","discover","ctx","ran","isEmpty","serviceNames","intersection","keys","map","ser","run","outputInfo","serviceName","runtime","runDependecies","_runDependencies","runPlugins","upperFirst","disableOp","isBoolean","disableOps","get","log","level","msg","getRuntime","state","Error","writeFileSync","dependsOn","dep","peerService","ret","filePath","test","loadServiceFile","defaults","discoverServices","defaultsDeep","hostIp","address","expose","isInteger","port","ip","isArray","exp","isUndefined","parent","env","globalEnv","exec","findService","console","printServiceInfo","childService","p","dir","dirname","pushd","file","localPath","merge","statePath","popd","basename","paths","sync","absolute","e","stack","pluginServices","hook","isFunction","x","config","silent","fatal","module","exports"],"mappings":"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","file":"bb-box.js","sourcesContent":["const _ = require('lodash');\r\nconst globby = require('globby');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst {AbstractService, Joi} = require('@kapitchi/bb-service');\r\nconst shell = require('shelljs');\r\nconst iplib = require('ip');\r\n\r\nconst serviceSchema = Joi.object({\r\n  name: Joi.string()\r\n}).options({allowUnknown: true});\r\n\r\nclass BbBox extends AbstractService {\r\n  /**\r\n   *\r\n   * @param bbBoxOpts\r\n   */\r\n  constructor(bbBoxOpts, runtimeLocal) {\r\n    super(bbBoxOpts, {\r\n      cwd: Joi.string().optional().default(process.cwd()),\r\n    });\r\n\r\n    this.plugins = [];\r\n    this.runtimes = {\r\n      local: runtimeLocal\r\n    };\r\n  }\r\n\r\n  setLogger(logger) {\r\n    super.setLogger(logger);\r\n    this.runtimes.local.setLogger(logger);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param plugin\r\n   */\r\n  registerPlugin(plugin) {\r\n    plugin.register(this);\r\n    this.plugins.push(plugin);\r\n  }\r\n\r\n  async shutdown() {\r\n    for (const plugin of this.plugins) {\r\n      if (plugin['onUnregister']) {\r\n        await plugin.onUnregister();\r\n      }\r\n    }\r\n\r\n    for (const runtimeName in this.runtimes) {\r\n      if (this.runtimes[runtimeName]['onUnregister']) {\r\n        await this.runtimes[runtimeName].onUnregister();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param params\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async install(params) {\r\n    params.op = 'install';\r\n    return this.runOp(params);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param params\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async update(params) {\r\n    params.op = 'update';\r\n    return this.runOp(params);\r\n  }\r\n\r\n  async start(params) {\r\n    params.op = 'start';\r\n    return this.runOp(params);\r\n  }\r\n\r\n  async stop(params) {\r\n    params.op = 'stop';\r\n    return this.runOp(params);\r\n  }\r\n\r\n  async reset(params) {\r\n    params.op = 'reset';\r\n    return this.runOp(params);\r\n  }\r\n\r\n  async status(params) {\r\n    params.op = 'status';\r\n    return this.runOp(params);\r\n  }\r\n\r\n  async runOp(params) {\r\n    params = this.params(params, {\r\n      op: Joi.string().allow('install', 'update', 'start', 'stop', 'reset', 'status'),\r\n      services: Joi.array().optional(),\r\n      skipDependencies: Joi.boolean().optional().default(false)\r\n    });\r\n\r\n    const service = await this.discover();\r\n\r\n    const ctx = {\r\n      ran: {}\r\n    };\r\n\r\n    let services = [];\r\n    if (!_.isEmpty(params.services)) {\r\n      //run on selected dependencies\r\n      const serviceNames = _.intersection(_.keys(service.services), params.services);\r\n      services = serviceNames.map(name => {\r\n        return service.services[name];\r\n      });\r\n    }\r\n    else {\r\n      //run for current/parent service\r\n      if (!params.skipDependencies) {\r\n        const serviceNames = _.keys(service.services);\r\n        //run on dependencies first\r\n        services = serviceNames.map(name => {\r\n          return service.services[name];\r\n        });\r\n      }\r\n      //then parent service\r\n      services.push(service);\r\n    }\r\n\r\n    for (const ser of services) {\r\n      await this.run({\r\n        service: ser,\r\n        op: params.op,\r\n        ctx,\r\n        skipDependencies: params.skipDependencies\r\n      });\r\n    }\r\n\r\n    if (params.op === 'status') {\r\n      this.outputInfo(service);\r\n    }\r\n  }\r\n\r\n  async run(params) {\r\n    //we want this by reference, this.params clones the params\r\n    const {service, ctx} = params;\r\n    params = this.params(params, {\r\n      service: serviceSchema,\r\n      op: Joi.string().allow('install', 'update', 'start', 'stop', 'reset', 'status'),\r\n      ctx: Joi.object(),\r\n      skipDependencies: Joi.boolean().optional().default(false)\r\n    });\r\n\r\n    //make sure we run a particular operation on a service once only\r\n    if (ctx.ran[service.name + params.op]) {\r\n      return;\r\n    }\r\n\r\n    const serviceName = `[${service.name}@${service.runtime}]`;\r\n\r\n    let runDependecies = true;\r\n    if (params.op !== 'stop') {\r\n      await this._runDependencies(ctx, service, params);\r\n      runDependecies = false;\r\n    }\r\n\r\n    ctx.ran[service.name + params.op] = true;\r\n\r\n    await this.runPlugins(`on${_.upperFirst(params.op)}Before`, {\r\n      service: params.service,\r\n    });\r\n\r\n    let disableOp = false;\r\n    if (_.isBoolean(service.disableOps)) {\r\n      disableOp = service.disableOps;\r\n    } else {\r\n      disableOp = _.get(service, `disableOps.${params.op}`, false);\r\n    }\r\n\r\n    if (disableOp) {\r\n      this.logger.log({\r\n        level: 'info',\r\n        msg: `${serviceName} Skipping ${params.op}`\r\n      });\r\n\r\n      if (runDependecies) {\r\n        await this._runDependencies(ctx, service, params);\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    this.logger.log({\r\n      level: 'info',\r\n      msg: `${serviceName} ${params.op}...`\r\n    });\r\n\r\n    const runtime = await this.getRuntime(service);\r\n    await runtime.run({\r\n      service,\r\n      op: params.op\r\n    });\r\n\r\n    await this.runPlugins(`on${_.upperFirst(params.op)}After`, {\r\n      service: params.service,\r\n    });\r\n\r\n    if (service.runtime === 'local' && service.state) {\r\n      if (!service.cwd) {\r\n        throw new Error('Service has no \"cwd\" set');\r\n      }\r\n      fs.writeFileSync(service.cwd + '/bb-box.state.json', JSON.stringify(service.state, null, 2));\r\n    }\r\n\r\n    this.logger.log({\r\n      level: 'info',\r\n      msg: `${serviceName} ... done`\r\n    });\r\n\r\n    if (runDependecies) {\r\n      await this._runDependencies(ctx, service, params);\r\n    }\r\n  }\r\n\r\n  async _runDependencies(ctx, service, params) {\r\n    if (!params.skipDependencies && !_.isEmpty(service.dependsOn)) {\r\n      for (const dep of service.dependsOn) {\r\n        const peerService = _.get(service, `parent.services.${dep}`);\r\n        if (!peerService) {\r\n          throw new Error(`Unknown peer service ${dep} of ${service.name}`);\r\n        }\r\n\r\n        await this.run({\r\n          service: peerService,\r\n          op: params.op,\r\n          ctx: ctx\r\n        });\r\n\r\n        //start peer services for install/update\r\n        if (params.op === 'install' || params.op === 'update') {\r\n          await this.run({\r\n            service: peerService,\r\n            op: 'start',\r\n            ctx: ctx\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  async discover(cwd) {\r\n    if (!cwd) {\r\n      cwd = this.options.cwd;\r\n    }\r\n\r\n    let ret = {\r\n      name: 'ROOT'\r\n    };\r\n\r\n    const filePath = cwd + '/bb-box.js';\r\n    if (this.shell.test('-f', filePath)) {\r\n      ret = this.loadServiceFile(filePath);\r\n    }\r\n\r\n    _.defaults(ret, {\r\n      runtime: 'local'\r\n    });\r\n\r\n    let services = await this.discoverServices(cwd);\r\n    ret.services = _.defaultsDeep({}, ret.services, services);\r\n      \r\n    const hostIp = iplib.address();\r\n    \r\n    //normalize service properties and set the parent\r\n    for (const name in ret.services) {\r\n      const ser = ret.services[name];\r\n\r\n      let expose = ser.expose;\r\n\r\n      if (_.isInteger(ser.expose)) {\r\n        expose = [\r\n          {port: ser.expose, ip: hostIp}\r\n        ];\r\n      } else if (_.isArray(expose)) {\r\n        expose = expose.map(exp => {\r\n          return {\r\n            ip: _.get(exp, 'ip', hostIp),\r\n            port: exp.port\r\n          }\r\n        });\r\n      } else if (_.isUndefined(expose)) {\r\n        this.logger.log({\r\n          level: 'warn',\r\n          msg: `Service ${name} does not have any exposed ports`\r\n        });\r\n      } else {\r\n        throw new Error('Unknown expose format: ' + expose);\r\n      }\r\n\r\n      ser.expose = expose;\r\n\r\n      ser.parent = ret;\r\n      ser.env = _.defaults({}, ret.services[name].env, ret.globalEnv);\r\n      ser.exec = _.defaults({}, ret.services[name].exec, _.get(ret, 'defaults.exec'));\r\n      _.defaults(ser, {\r\n        runtime: 'local'\r\n      });\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  async findService(serviceName) {\r\n    const service = await this.discover();\r\n    if (!service.services || !service.services[serviceName]) {\r\n      return null;\r\n    }\r\n    return service.services[serviceName];\r\n  }\r\n\r\n  outputInfo(service) {\r\n    console.log('=============='); //XXX\r\n    console.log('Service status'); //XXX\r\n    console.log('=============='); //XXX\r\n    this.printServiceInfo(service);\r\n  }\r\n\r\n  printServiceInfo(service) {\r\n    console.log(`[${service.name}@${service.runtime}]: ${service.status}`); //XXX\r\n\r\n    if (!service.services) {\r\n      return;\r\n    }\r\n\r\n    for (const childService of Object.values(service.services)) {\r\n      this.printServiceInfo(childService);\r\n    }\r\n  }\r\n\r\n  loadServiceFile(p) {\r\n    const dir = path.dirname(p);\r\n\r\n    this.shell.pushd(dir);\r\n\r\n    const file = require(p);\r\n\r\n    const localPath = dir + '/bb-box.local.js';\r\n    if (this.shell.test('-f', localPath)) {\r\n      const local = require(localPath);\r\n      _.merge(file, local);\r\n    }\r\n\r\n    const statePath = dir + '/bb-box.state.json';\r\n    if (this.shell.test('-f', statePath)) {\r\n      file.state = require(statePath);\r\n    } else {\r\n      file.state = {};\r\n    }\r\n\r\n    this.shell.popd();\r\n\r\n    file.cwd = dir;\r\n\r\n    if (!file.name) {\r\n      file.name = path.basename(dir);\r\n    }\r\n\r\n    _.defaults(file, {\r\n      //runtime: 'local' // cannot be set here, because docker-compose service runtime won't be set\r\n    });\r\n\r\n    return file;\r\n  }\r\n\r\n  async discoverServices(cwd) {\r\n    const paths = globby.sync('*/bb-box.js', {\r\n      cwd: cwd,\r\n      absolute: true\r\n    });\r\n\r\n    const services = {};\r\n    for (const p of paths) {\r\n      try {\r\n        const file = this.loadServiceFile(p);\r\n        services[file.name] = file;\r\n      } catch (e) {\r\n        throw new Error(`Service file error. Service disabled. ${p}: ${e}\\n${e.stack}`);\r\n      }\r\n    }\r\n\r\n    const pluginServices = await this.runPlugins('discoverServices');\r\n\r\n    //TODO do some magic to merge/select values from discovered plugin services\r\n    _.defaultsDeep(services, pluginServices);\r\n\r\n    return services;\r\n  }\r\n\r\n  /**\r\n   * Must return something what can be deepMerged\r\n   *\r\n   * @param hook\r\n   * @param [params]\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async runPlugins(hook, params) {\r\n    const ret = {};\r\n\r\n    for (const plugin of this.plugins) {\r\n      if (!_.isFunction(plugin[hook])) {\r\n        continue;\r\n      }\r\n\r\n      const x = await plugin[hook](params);\r\n      _.defaultsDeep(ret, x);\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  async getRuntime(service) {\r\n    const runtimeName = _.get(service, 'runtime', 'local');\r\n    if (!this.runtimes[runtimeName]) {\r\n      throw new Error(`No runtime registered ${runtimeName}`);\r\n    }\r\n\r\n    return this.runtimes[runtimeName];\r\n  }\r\n\r\n  get shell() {\r\n    //https://github.com/shelljs/shelljs#configsilent\r\n    shell.config.reset();\r\n    shell.config.silent = true;\r\n    shell.config.fatal = true;\r\n    //shell.config.verbose = true;\r\n    return shell;\r\n  }\r\n}\r\n\r\nmodule.exports = BbBox;\r\n"]}
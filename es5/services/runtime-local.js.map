{"version":3,"sources":["../../src/services/runtime-local.js"],"names":["AbstractService","Joi","require","_","shell","inquirer","blubird","pm2","promisifyAll","RuntimeLocal","constructor","onUnregister","pm2Disconnect","run","params","service","object","op","string","includes","runPm2","some","processEnv","clone","process","env","defaults","pushd","cwd","deps","isUndefined","console","log","runOperation","runMigrations","logger","level","msg","name","popd","Error","isArray","one","isFunction","createContext","isString","cmd","opts","execOpts","silent","exec","error","migrations","lastMigrationIndex","get","migIndex","parseInt","mig","migName","description","ctx","up","state","lastMigration","e","down","warn","pm2Connect","ret","startAsync","isEmpty","isObject","pm2Process","stopAsync","message","x","describeAsync","status","undefined","pm2_env","c","prompt","apply","arguments","cmdPlaceholder","template","omit","windowsHide","replace","connectAsync","disconnect","config","reset","module","exports"],"mappings":"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","file":"runtime-local.js","sourcesContent":["const {AbstractService, Joi} = require('@kapitchi/bb-service');\r\nconst _ = require('lodash');\r\nconst shell = require('shelljs');\r\nconst inquirer = require('inquirer');\r\nconst blubird = require('bluebird');\r\nconst pm2 = blubird.promisifyAll(require('pm2'));\r\n\r\nclass RuntimeLocal extends AbstractService {\r\n  constructor() {\r\n    super();\r\n    this.pm2 = null;\r\n  }\r\n\r\n  onUnregister() {\r\n    this.pm2Disconnect();\r\n  }\r\n\r\n  async run(params) {\r\n    this.params(params, {\r\n      service: Joi.object(),\r\n      op: Joi.string()\r\n    });\r\n\r\n    //need references not clones so we don't do `params = this.params()`\r\n    const {service, op} = params;\r\n\r\n    if (_.includes(['start', 'stop', 'status'], op)) {\r\n      return await this.runPm2(service, op);\r\n    }\r\n\r\n    const some = service[op];\r\n\r\n    //run sync\r\n    if (_.includes(['install', 'update', 'reset'], op)) {\r\n      const processEnv = _.clone(process.env);\r\n      process.env = _.defaults({}, service.env, process.env);\r\n\r\n      this.shell.pushd(service.cwd);\r\n\r\n      // We run install/update dependencies.\r\n      // On 'update' op, when updateDependencies is not available we default to installDependencies\r\n      let deps = null;\r\n      if (op === 'install') {\r\n        deps = service['installDependencies'];\r\n      }\r\n      else if (op === 'update') {\r\n        deps = service['updateDependencies'];\r\n        if (_.isUndefined(deps)) {\r\n          deps = service['installDependencies'];\r\n        }\r\n      }\r\n\r\n      if (deps) {\r\n        console.log('Running deps install/update...'); //XXX\r\n        await this.runOperation(service, deps);\r\n      }\r\n\r\n      //END\r\n\r\n      //run migrations\r\n      if (op === 'install' || op === 'update') {\r\n        await this.runMigrations(service);\r\n      }\r\n\r\n      //run the operation itself\r\n      if (_.isUndefined(some)) {\r\n        this.logger.log({\r\n          level: 'warn',\r\n          msg: `[${service.name}] no \"${op}\" op`\r\n        });\r\n        return;\r\n      }\r\n\r\n      await this.runOperation(service, some);\r\n\r\n      process.env = processEnv;\r\n\r\n      this.shell.popd();\r\n      return;\r\n    }\r\n\r\n    throw new Error(`Runtime local: Op \"${op}\" not implemented`);\r\n  }\r\n\r\n  async runOperation(service, some) {\r\n    if (_.isArray(some)) {\r\n      for (const one of some) {\r\n        await this.runOperation(service, one);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (_.isFunction(some)) {\r\n      await some(this.createContext(service));\r\n      return;\r\n    }\r\n\r\n    if (_.isString(some)) {\r\n      const {cmd, opts} = this.execOpts(service, some);\r\n      opts.silent = false;\r\n      this.shell.exec(cmd, opts);\r\n      return;\r\n    }\r\n\r\n    console.error(some); //XXX\r\n    throw new Error('Can not run operation implemented as ' + typeof some);\r\n  }\r\n\r\n  async runMigrations(service) {\r\n    if (!service.migrations) {\r\n      return;\r\n    }\r\n\r\n    const lastMigrationIndex = _.get(service, 'state.lastMigration', -1);\r\n\r\n    for (let migIndex in service.migrations) {\r\n      migIndex = parseInt(migIndex);\r\n      const mig = service.migrations[migIndex];\r\n      const migName = `${migIndex} ${mig.description ? '- ' + mig.description : '(no description)'}`;\r\n\r\n      if (migIndex <= lastMigrationIndex) {\r\n        console.log(`Skipping migration ${migName}`);\r\n        continue;\r\n      }\r\n\r\n      const ctx = this.createContext(service);\r\n      try {\r\n        console.log(`Running migration: ${migName}`);\r\n        await mig.up(ctx);\r\n        service.state.lastMigration = migIndex\r\n        console.log('... done'); //XXX\r\n      } catch(e) {\r\n        console.error('Migration error', e); //XXX\r\n        if (!mig.down) {\r\n          console.warn('No migration down');\r\n          return;\r\n        }\r\n\r\n        try {\r\n          await mig.down(ctx);\r\n        } catch(e) {\r\n          console.error('Migration down error: ', e); //XXX\r\n          throw e;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * we use pm2 to start/stop processes\r\n   * http://pm2.keymetrics.io/docs/usage/pm2-api/\r\n   *\r\n   * @param service\r\n   * @param op\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async runPm2(service, op) {\r\n    const pm2 = await this.pm2Connect(service);\r\n\r\n    switch (op) {\r\n      case 'start':\r\n        const some = service[op];\r\n        const env = _.defaults({}, service.env);\r\n\r\n        // file path to PM2 ecosystem file\r\n        if (_.isString(some)) {\r\n          this.shell.pushd(service.cwd);\r\n          try {\r\n            // const runSpec = {\r\n            //   name: service.name,\r\n            //   script: some,\r\n            //   cwd: service.cwd,\r\n            //   //interpreter: 'none',\r\n            //   //force: true,\r\n            //   env,\r\n            // };\r\n            const ret = await pm2.startAsync(some, {\r\n              env\r\n            });\r\n            if (_.isEmpty(ret)) {\r\n              throw new Error('Could not start PM2 process');\r\n            }\r\n            this.logger.log({\r\n              level: 'info',\r\n              msg: `${service.name} PM2 process started`,\r\n            });\r\n          } catch(e) {\r\n            console.log(e); //XXX\r\n            throw e;\r\n          }\r\n          this.shell.popd();\r\n        } else if (_.isObject(some)) {\r\n          const pm2Process = _.defaults({}, some, {\r\n            name: service.name,\r\n            cwd: service.cwd,\r\n            env,\r\n          });\r\n\r\n          //pm2Process.force = true;\r\n\r\n          // try {\r\n          //   await pm2.deleteAsync(service.name);\r\n          // } catch(e) {\r\n          //   //ignore delete errors\r\n          // }\r\n\r\n          try {\r\n            const ret = await pm2.startAsync(pm2Process);\r\n\r\n            if (_.isEmpty(ret)) {\r\n              throw new Error('Could not start PM2 process');\r\n            }\r\n            this.logger.log({\r\n              level: 'info',\r\n              msg: `${service.name} PM2 process started`,\r\n            });\r\n          } catch (e) {\r\n            console.log(e); //XXX\r\n            throw e;\r\n          }\r\n        } else {\r\n          this.logger.log({\r\n            level: 'info',\r\n            msg: `${service.name} No start op`,\r\n          });\r\n        }\r\n        break;\r\n      case 'stop':\r\n        try {\r\n          await pm2.stopAsync(service.name);\r\n        } catch (e) {\r\n          if (e.message !== 'process name not found') {\r\n            throw e;\r\n          }\r\n          this.logger.log({\r\n            level: 'warn',\r\n            msg: `${service.name} PM2 process does not exist`,\r\n          });\r\n        }\r\n        break;\r\n      case 'status':\r\n        const x = await pm2.describeAsync(service.name);\r\n        service.status = undefined;\r\n        if (!_.isEmpty(x)) {\r\n          service.status = x[0].pm2_env.status === 'online' ? 'running' : 'stopped';\r\n        }\r\n\r\n        break;\r\n    }\r\n  }\r\n\r\n  createContext(service) {\r\n    return {\r\n      name: service.name,\r\n      cwd: service.cwd,\r\n      shell: this.shell,\r\n      exec: (c) => {\r\n        const {cmd, opts} = this.execOpts(service, c);\r\n        return this.shell.exec(cmd, opts);\r\n      },\r\n      prompt: function() {\r\n        return inquirer.prompt.apply(inquirer.prompt, arguments);\r\n      },\r\n      log: console.log, //XXX\r\n      warn: console.warn //XXX\r\n    }\r\n  }\r\n\r\n  execOpts(service, cmd) {\r\n    const cmdPlaceholder = '${CMD}';\r\n    const template = _.get(service, 'exec.template', cmdPlaceholder);\r\n    const env = _.defaults({}, service.env, process.env);\r\n    const opts = _.defaults({}, _.omit(service.exec, 'template'), {\r\n      //async: true //TODO\r\n      silent: false,\r\n      windowsHide: true, //do not open terminal window on Windows\r\n      env\r\n    });\r\n\r\n    cmd = template.replace(cmdPlaceholder, cmd);\r\n    return {\r\n      cmd,\r\n      opts\r\n    }\r\n  }\r\n\r\n  async pm2Connect(service) {\r\n    if (!this.pm2) {\r\n      await pm2.connectAsync();\r\n      console.log('>>> PM2 connected'); //XXX\r\n      this.pm2 = pm2;\r\n    }\r\n\r\n    this.pm2.cwd = service.cwd;\r\n\r\n    return this.pm2;\r\n  }\r\n\r\n  pm2Disconnect() {\r\n    if (this.pm2) {\r\n      this.pm2.disconnect();\r\n      this.pm2 = null;\r\n    }\r\n  }\r\n\r\n  get shell() {\r\n    shell.config.reset();\r\n    shell.config.silent = true;\r\n    return shell;\r\n  }\r\n}\r\n\r\nmodule.exports = RuntimeLocal;\r\n"]}